<script>
    // Hàm tính hạng cho một bài kiểm tra cụ thể
    function getTestRank(testIndex, score) {
        const sortedScores = students.map(s => s.scores[testIndex]).sort((a, b) => b - a);
        const index = sortedScores.indexOf(score);
        const higherScoresCount = sortedScores.filter((s, i) => i < index && s > score).length;
        const sameScoreCount = sortedScores.filter(s => s === score).length;
        return higherScoresCount + sameScoreCount;
    }

    // Hàm tính hạng tổng
    function getTotalRank(totalScore) {
        const sortedTotals = students.map(s => s.scores.reduce((a,b)=>a+b,0)).sort((a, b) => b - a);
        const index = sortedTotals.indexOf(totalScore);
        const higherTotalsCount = sortedTotals.filter((s, i) => i < index && s > totalScore).length;
        const sameTotalCount = sortedTotals.filter(s => s === totalScore).length;
        return higherTotalsCount + sameTotalCount;
    }

    // Hàm tính tổng điểm
    function getTotalScore(scores) {
        return scores.reduce((a, b) => a + b, 0).toFixed(1);
    }

    // Hàm tra cứu điểm
    function searchScores() {
        const inputName = document.getElementById("studentName").value.trim();
        const resultDiv = document.getElementById("result");

        if (!inputName) {
            resultDiv.innerHTML = '<p class="error">Vui lòng nhập tên học sinh!</p>';
            return;
        }

        const student = students.find(s => s.name.toLowerCase() === inputName.toLowerCase());

        if (!student) {
            resultDiv.innerHTML = '<p class="error">Không tìm thấy học sinh với tên này!</p>';
            return;
        }

        const totalScore = parseFloat(getTotalScore(student.scores));
        const ranks = student.scores.map((score, i) => getTestRank(i, score));
        const totalRank = getTotalRank(totalScore);

        resultDiv.innerHTML = `
            <h3>Kết quả của ${student.name}</h3>
            <table>
                <tr>
                    <th>Bài kiểm tra</th>
                    <th>Điểm</th>
                    <th>Hạng / 35</th>
                </tr>
                <tr>
                    <td>KT 1 (8/8/2025)</td>
                    <td>${student.scores[0]}</td>
                    <td>${ranks[0]}/35</td>
                </tr>
                <tr>
                    <td>KT 2 (22/8/2025)</td>
                    <td>${student.scores[1]}</td>
                    <td>${ranks[1]}/35</td>
                </tr>
                <tr>
                    <td>KT 3 (??/??/2025)</td>
                    <td>${student.scores[2]}</td>
                    <td>${ranks[2]}/35</td>
                </tr>
                <tr>
                    <td><b>Tổng điểm</b></td>
                    <td><b>${totalScore}</b></td>
                    <td><b>${totalRank}/35</b></td>
                </tr>
            </table>
        `;
    }

    // Xử lý Enter
    document.getElementById("studentName").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            searchScores();
        }
    });
</script>
